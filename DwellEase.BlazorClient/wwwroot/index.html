<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация</title>
</head>
<body>
<h1>Регистрация</h1>
<form id="registrationForm">
    <label for="emailId">Email:</label>
    <input type="text" id="emailId" required><br>

    <label for="passwordId">Пароль:</label>
    <input type="password" id="passwordId" required><br>

    <label for="usernameId">Имя:</label>
    <input type="text" id="usernameId" required><br>

    <label for="roleId">Роль:</label>
    <input type="text" id="roleId" required><br>

    <label for="phoneNumberId">Номер телефона:</label>
    <input type="text" id="phoneNumberId" required><br>

    <button type="button" id="submitRegistration">Зарегистрироваться</button>
</form>

<div id="tokenInfo" style="display: none;">
    <h2>Access Token:</h2>
    <p id="accessToken"></p>
    <h2>Данные из токена:</h2>
    <p>Роль: <span id="roleInfo"></span></p>
    <p>Имя: <span id="nameInfo"></span></p>
</div>
<div id="tokenExpirationInfo" style="display: none;">
    <h2>Срок действия токена:</h2>
    <p id="expirationTime"></p>
</div>


<script>
    // Функция для отправки запроса на регистрацию
    async function registerUser() {
        try {
            // Создаем объект с данными для регистрации
            const registrationData = {
                Email: document.getElementById("emailId").value,
                Password: document.getElementById("passwordId").value,
                UserName: document.getElementById("usernameId").value,
            };

            // Отправляем POST-запрос к серверу для регистрации
            const response = await fetch("https://localhost:44387/Account/Register", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify(registrationData)
            });

            // Если запрос прошел нормально
            if (response.ok === true) {
                // Получаем данные, если есть
                const data = await response.json();
                // Ваши действия после успешной регистрации (например, перенаправление пользователя)
                console.log("Регистрация прошла успешно:", data);

                // Отображаем полученный Access Token
                document.getElementById("tokenInfo").style.display = "block";
                document.getElementById("accessToken").innerText = data.token;

                // Декодируем токен, чтобы получить информацию из него
                const tokenData = decodeToken(data.token);
                // Выводим информацию о роли и имени из декодированного токена
                document.getElementById("roleInfo").innerText = tokenData["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
                document.getElementById("nameInfo").innerText = tokenData["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"];

                // Выводим оставшееся время до истечения срока действия токена
                const expirationTimeInSeconds = tokenData.exp;

                // Получаем текущее время (время в секундах с 1970 года)
                const currentTimeInSeconds = Math.floor(Date.now() / 1000);

                // Вычисляем оставшееся время (в секундах) до истечения срока действия
                const timeUntilExpirationInSeconds = expirationTimeInSeconds - currentTimeInSeconds;

                // Преобразуем время в формат "ЧЧ:ММ:СС"
                const hours = Math.floor(timeUntilExpirationInSeconds / 3600);
                const minutes = Math.floor((timeUntilExpirationInSeconds % 3600) / 60);
                const seconds = Math.floor(timeUntilExpirationInSeconds % 60);

                // Выводим оставшееся время
                document.getElementById("tokenExpirationInfo").style.display = "block";
                document.getElementById("expirationTime").innerText = `Срок действия: ${hours} часов ${minutes} минут ${seconds} секунд`;
            } else {
                // Если произошла ошибка, получаем код статуса и текст ошибки
                const errorData = await response.json();
                console.error("Ошибка при регистрации:", errorData);
            }
        } catch (error) {
            // Обработка других ошибок
            console.error("Ошибка при регистрации:", error);
        }
    }

    // Обработчик нажатия кнопки "Зарегистрироваться"
    document.getElementById("submitRegistration").addEventListener("click", async () => {
        await registerUser();
    });

    // Функция для декодирования JWT-токена
    function decodeToken(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
</script>
</body>
</html>
